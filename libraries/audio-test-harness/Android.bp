/*
 * Copyright (C) 2020 The Android Open Source Project
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

// PROTOS

PROTO_TOOLS = ["aprotoc", "protoc-gen-grpc-java-plugin", "soong_zip"]
PROTO_CMD = "mkdir -p $(genDir)/gen && "+
        "$(location aprotoc) -Iplatform_testing/libraries -Iexternal/protobuf/src "+
        "--plugin=protoc-gen-grpc-java=$(location protoc-gen-grpc-java-plugin) --grpc-java_out=$(genDir)/gen $(in) && "+
        "$(location soong_zip) -o $(out) -C $(genDir)/gen -D $(genDir)/gen"

// Common protos shared between the server and client libraries as model classes.
filegroup {
    name: "AudioTestHarnessCommonProto",
    srcs: [
        "proto/audio_device.proto",
        "proto/audio_format.proto",
    ]
}


// The protos for the Audio Test Harness service definition.
filegroup {
    name: "AudioTestHarnessServiceProto",
    srcs: [
        "proto/audio_test_harness_service.proto"
    ],
}

// The generated gRPC Stub based on the above service definition.
genrule {
    name: "AudioTestHarnessServiceStub",
    tools: PROTO_TOOLS,
    cmd: PROTO_CMD,
    srcs: [
        ":AudioTestHarnessServiceProto"
    ],
    out: [
        "protos.srcjar"
    ],
}

// SHARED

java_library {
    name: "AudioTestHarnessCommon",
    host_supported: true,
    srcs: [
      "src/main/java/com/android/media/audiotestharness/common/Defaults.java",
      ":AudioTestHarnessCommonProto"
    ],
    static_libs: [
        "libprotobuf-java-lite"
    ],
    java_version: "1.8",
    proto: {
        type: "lite",
    }
}

// SERVER

java_binary_host {
    name: "AudioTestHarnessServer",
    static_libs: [
        "AudioTestHarnessServerLib"
    ],
    java_version: "1.8",
    manifest: "server-manifest.inf"
}

// SERVER - Libraries

java_library_host {
    name: "AudioTestHarnessServerLib",
    srcs: [
        "src/main/java/com/android/media/audiotestharness/server/AudioTestHarnessGrpcServer.java",
        "src/main/java/com/android/media/audiotestharness/server/AudioTestHarnessServerModule.java"
    ],
    static_libs: [
        "AudioTestHarnessService",
        "AudioTestHarnessUtility",

        // gRPC Dependencies
        "grpc-java",
        "grpc-java-netty-shaded",
        "opencensus-java-api"
    ],
    java_version: "1.8"
}

java_library_host {
    name: "AudioTestHarnessService",
    srcs: [
        "src/main/java/com/android/media/audiotestharness/server/service/AudioTestHarnessImpl.java",
        ":AudioTestHarnessCommon",
        ":AudioTestHarnessCommonProto",
        ":AudioTestHarnessServiceProto",
        ":AudioTestHarnessServiceStub"
    ],
    static_libs: [
        "libprotobuf-java-full",
        "grpc-java",
        "guava",
        "guice",
    ],
    java_version: "1.8",
    proto: {
        type: "full",
    }
}

java_library_host {
    name: "AudioTestHarnessUtility",
    srcs: [
        "src/main/java/com/android/media/audiotestharness/server/utility/*.java"
    ],
    java_version: "1.8"
}

// SERVER - Tests

java_test_host {
    name: "AudioTestHarnessServerLibTests",
    test_suites: ["general-tests"],
    srcs: [
        "src/test/java/com/android/media/audiotestharness/server/AudioTestHarnessServerModuleTests.java",
        "src/test/java/com/android/media/audiotestharness/server/AudioTestHarnessGrpcServerTests.java",
        "src/test/java/com/android/media/audiotestharness/server/AudioTestHarnessTestImpl.java"
    ],
    static_libs: [
        "AudioTestHarnessServerLib",
        "junit",
        "mockito",

        // gRPC Dependencies
        "grpc-java",
        "grpc-java-netty-shaded",
        "opencensus-java-api"
    ],
    java_version: "1.8"
}

java_test_host {
    name: "AudioTestHarnessServiceTests",
    test_suites: ["general-tests"],
    srcs: [
        "src/test/java/com/android/media/audiotestharness/server/service/AudioTestHarnessImplTests.java",
        ":AudioTestHarnessServiceProto",
        ":AudioTestHarnessServiceStub"
    ],
    static_libs: [
        "AudioTestHarnessService",
        "junit",
        "guava"
    ],
    java_version: "1.8",
    proto: {
        type: "full",
    }
}

java_test_host {
    name: "AudioTestHarnessUtilityTests",
    test_suites: ["general-tests"],
    srcs: [
        "src/test/java/com/android/media/audiotestharness/server/utility/*.java"
    ],
    static_libs: [
        "AudioTestHarnessUtility",
        "junit",
    ],
    java_version: "1.8"
}
