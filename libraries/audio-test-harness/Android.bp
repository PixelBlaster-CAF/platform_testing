/*
 * Copyright (C) 2020 The Android Open Source Project
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

// PROTOS

PROTO_TOOLS = ["aprotoc", "protoc-gen-grpc-java-plugin", "soong_zip"]
PROTO_CMD = "mkdir -p $(genDir)/gen && "+
        "$(location aprotoc) -Iplatform_testing/libraries -Iexternal/protobuf/src "+
        "--plugin=protoc-gen-grpc-java=$(location protoc-gen-grpc-java-plugin) --grpc-java_out=$(genDir)/gen $(in) && "+
        "$(location soong_zip) -o $(out) -C $(genDir)/gen -D $(genDir)/gen"

// Common protos shared between the server and client libraries as model classes.
filegroup {
    name: "audiotestharness-commonproto",
    srcs: [
        "proto/audio_device.proto",
        "proto/audio_format.proto"
    ]
}


// The protos for the Audio Test Harness service definition.
filegroup {
    name: "audiotestharness-serviceproto",
    srcs: [
        "proto/audio_test_harness_service.proto"
    ],
}

// The generated gRPC Stub based on the above service definition.
genrule {
    name: "audiotestharness-servicestub",
    tools: PROTO_TOOLS,
    cmd: PROTO_CMD,
    srcs: [
        ":audiotestharness-serviceproto"
    ],
    out: [
        "protos.srcjar"
    ],
}

// SHARED

java_library {
    name: "audiotestharness-commonlib",
    host_supported: true,
    srcs: [
      "src/main/java/com/android/media/audiotestharness/common/Defaults.java",
      ":audiotestharness-commonproto"
    ],
    static_libs: [
        "libprotobuf-java-lite"
    ],
    java_version: "1.8",
    proto: {
        type: "lite",
    }
}

// SERVER

java_binary_host {
    name: "audiotestharness-clicapturer",
    srcs: [
        "src/main/java/com/android/media/audiotestharness/server/examples/AudioTestHarnessCliCapturer.java",
        ":audiotestharness-commonproto"
    ],
    static_libs: [
        "audiotestharness-javasoundlib",
        "audiotestharness-commonlib",
        "audiotestharness-corelib",
        "libprotobuf-java-lite",
        "guava"
    ],
    java_version: "1.8",
    manifest: "cli-capturer-manifest.inf",
    proto: {
        type: "lite"
    }
}

java_binary_host {
    name: "audiotestharness-server",
    static_libs: [
        "audiotestharness-serverlib"
    ],
    java_version: "1.8",
    manifest: "server-manifest.inf"
}

// SERVER - Libraries

java_library_host {
    name: "audiotestharness-serverlib",
    srcs: [
        "src/main/java/com/android/media/audiotestharness/server/AudioTestHarnessGrpcServer.java",
        "src/main/java/com/android/media/audiotestharness/server/AudioTestHarnessServerModule.java"
    ],
    static_libs: [
        "audiotestharness-servicelib",
        "audiotestharness-utilitylib",

        // gRPC Dependencies
        "grpc-java",
        "grpc-java-netty-shaded",
        "opencensus-java-api"
    ],
    java_version: "1.8"
}

java_library_host {
    name: "audiotestharness-corelib",
    srcs: [
        "src/main/java/com/android/media/audiotestharness/server/core/*.java",
        ":audiotestharness-commonproto"
    ],
    static_libs: [
        "audiotestharness-commonlib",
        "libprotobuf-java-full",
        "guava"
    ],
    java_version: "1.8",
    proto: {
        type: "full"
    }
}

java_library_host {
    name: "audiotestharness-servicelib",
    srcs: [
        "src/main/java/com/android/media/audiotestharness/server/service/*.java",
        ":audiotestharness-commonproto",
        ":audiotestharness-serviceproto",
        ":audiotestharness-servicestub",
    ],
    static_libs: [
        "audiotestharness-commonlib",
        "libprotobuf-java-full",
        "grpc-java",
        "guava",
        "guice"
    ],
    java_version: "1.8",
    proto: {
        type: "full",
    }
}

java_library_host {
    name: "audiotestharness-javasoundlib",
    srcs: [
        "src/main/java/com/android/media/audiotestharness/server/javasound/*.java",
        ":audiotestharness-commonproto"
    ],
    static_libs: [
        "audiotestharness-corelib",
        "libprotobuf-java-lite",
        "guava",
        "guice"
    ],
    java_version: "1.8",
    proto: {
        type: "lite",
    }
}

java_library_host {
    name: "audiotestharness-utilitylib",
    srcs: [
        "src/main/java/com/android/media/audiotestharness/server/utility/*.java"
    ],
    java_version: "1.8"
}

// SERVER - Tests

java_test_host {
    name: "audiotestharness-serverlib-tests",
    test_suites: ["general-tests"],
    srcs: [
        "src/test/java/com/android/media/audiotestharness/server/AudioTestHarnessServerModuleTests.java",
        "src/test/java/com/android/media/audiotestharness/server/AudioTestHarnessGrpcServerTests.java",
        "src/test/java/com/android/media/audiotestharness/server/AudioTestHarnessTestImpl.java"
    ],
    static_libs: [
        "audiotestharness-serverlib",
        "junit",
        "junit-params",
        "mockito",

        // gRPC Dependencies
        "grpc-java",
        "grpc-java-netty-shaded",
        "opencensus-java-api"
    ],
    java_version: "1.8"
}

java_test_host {
    name: "audiotestharness-servicelib-tests",
    test_suites: ["general-tests"],
    srcs: [
        "src/test/java/com/android/media/audiotestharness/server/service/*.java",
        ":audiotestharness-serviceproto",
        ":audiotestharness-servicestub",
    ],
    static_libs: [
        "audiotestharness-servicelib",
        "junit",
        "junit-params",
        "mockito",
        "guava"
    ],
    java_version: "1.8",
    proto: {
        type: "full",
    }
}

java_test_host {
    name: "audiotestharness-javasoundlib-tests",
    test_suites: ["general-tests"],
    srcs: [
        "src/test/java/com/android/media/audiotestharness/server/javasound/*.java",
        ":audiotestharness-commonproto"
    ],
    static_libs: [
        "audiotestharness-corelib",
        "audiotestharness-javasoundlib",
        "libprotobuf-java-lite",
        "guava",
        "junit",
        "mockito"
    ],
    java_version: "1.8",
    proto: {
        type: "lite",
    }
}

java_test_host {
    name: "audiotestharness-utilitylib-tests",
    test_suites: ["general-tests"],
    srcs: [
        "src/test/java/com/android/media/audiotestharness/server/utility/*.java"
    ],
    static_libs: [
        "audiotestharness-utilitylib",
        "junit"
    ],
    java_version: "1.8"
}
